<!DOCTYPE html>
<html>
<head>
  <title>Chat-io</title>
  <link rel="stylesheet" type="text/css" href="css/chat.css">
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
</head>
<body>
  <header>
    <h1>Chat-io</h1>
  </header>
  <aside>
    <h2>Users</h2>
    <ul id="users"></ul>
  </aside>
  <section id="messages">
    <h2>Messages</h2>
  </section>
  <section id="new-message">
    <input type="text" id="input" />
    <button id="send">Send</button>
  </section>
  <script>

    var socket = io.connect();
    var userList = document.getElementById('users');
    var sendButton = document.getElementById('send');
    var messages = document.getElementById('messages');
    var textIn = document.getElementById('input');
    var user = prompt('username?');

    socket.emit('login', user);

    function addNewUser(name){
      var item = document.createElement('li');
      var txt = document.createTextNode(name);
      item.appendChild(txt);
      userList.appendChild(item);
    }

    function sendMessage(e){
      e.preventDefault();
      var msg = textIn.value;
      socket.emit('new message', {name: user, message: msg});
      textIn.value = '';
    }

    function addMessage(data){
      var entry = document.createElement('div');
      var txt = document.createTextNode(data.name + ': ' + data.message);
      entry.appendChild(txt);
      messages.appendChild(entry);
    }

    function sendOnEnter(e){
      if(e.keyCode === 13){
        sendMessage(e);
      }
    }

    sendButton.addEventListener('click', sendMessage, false);
    textIn.addEventListener('keypress', sendOnEnter, false);

    socket.on('online users', function(data){

      while (userList.firstChild) {
        userList.removeChild(userList.firstChild);
      }

      data.forEach(function(el){
        addNewUser(el);
      });

    });

    socket.on('new user', function(data){
      addNewUser(data);
    });

    socket.on('message', function(data){
      addMessage(data);
    });

  </script>
</body>
</html>
